<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillGate Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Light Theme Colors */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-dark: #4c63d2;
            --primary-light: #8b9cf7;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            
            --bg-primary: #f8fafc;
            --bg-secondary: #f1f5f9;
            --bg-card: #ffffff;
            --bg-hover: #f8fafc;
            
            --border-light: #e2e8f0;
            --border-medium: #cbd5e1;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --spacing: 1rem;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            /* Dark Theme Colors */
            --primary-gradient: linear-gradient(135deg, #4c63d2 0%, #6366f1 100%);
            --primary-dark: #6366f1;
            --primary-light: #8b9cf7;
            
            --text-primary: #e0e7ff;
            --text-secondary: #a8b4e0;
            --text-muted: #9ca3af;
            
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #2d3a4b;
            --bg-hover: #475569;
            
            --border-light: #475569;
            --border-medium: #64748b;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        [data-theme="dark"] .form-control::placeholder {
            color: var(--text-secondary);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
            overflow-x: hidden;
        }

        body.modal-open {
            overflow: hidden;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
        }

        .modal-overlay.modal-show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--bg-card);
            padding: 2rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            width: 90%;
            text-align: center;
            color: var(--text-primary);
        }

        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .modal-content p {
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        .modern-card {
            background: var(--bg-card);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            transition: var(--transition);
            overflow: hidden;
            position: relative;
        }

        .modern-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .modern-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .admin-header {
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left h1 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.025em;
            margin-bottom: 0.5rem;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 50px;
            padding: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            background: var(--bg-hover);
            transform: scale(1.05);
        }

        .welcome-badge {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 500;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .test-status-badge {
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            border: 1px solid;
        }

        .test-status-badge.active {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .test-status-badge.paused {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .test-status-badge i {
            font-size: 0.6rem;
        }

        .test-page-badge {
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            border: 1px solid;
            cursor: pointer;
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .test-page-badge:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .test-page-badge i {
            font-size: 0.6rem;
        }

        .btn-modern {
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--accent-blue), #2563eb);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--accent-orange), #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-medium);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--bg-hover);
            border-color: var(--primary-dark);
            color: var(--primary-dark);
        }

        .controls-section {
            padding: 2rem;
            margin-bottom: 2rem;
        }

        /* NEW IMPROVED LAYOUT */
        .controls-layout {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1.5rem;
            align-items: end;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .actions-row {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        @media (max-width: 1024px) {
            .filters-row {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
            
            .filter-item:first-child {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .filters-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .filter-item:first-child {
                grid-column: 1;
            }
            
            .actions-row {
                justify-content: center;
                gap: 0.5rem;
            }
            
            .btn-modern {
                padding: 0.75rem 1.25rem;
                font-size: 0.875rem;
            }
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-control::placeholder {
            color: var(--text-muted);
            opacity: 1;
        }

        .input-group {
            position: relative;
            display: flex;
        }

        .input-group .form-control {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            border-right: none;
        }

        .input-group .btn-modern {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .stats-section {
            margin-bottom: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.25rem;
            color: white;
        }

        .stat-icon.primary { background: var(--primary-gradient); }
        .stat-icon.success { background: linear-gradient(135deg, var(--accent-green), #059669); }
        .stat-icon.warning { background: linear-gradient(135deg, var(--accent-orange), #d97706); }
        .stat-icon.info { background: linear-gradient(135deg, var(--accent-blue), #2563eb); }
        .stat-icon.danger { background: linear-gradient(135deg, var(--accent-red), #dc2626); }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.875rem;
        }

        .table-section {
            padding: 0;
        }

        .table-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-container {
            overflow-x: auto;
        }

        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .modern-table thead th {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modern-table tbody td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
            vertical-align: middle;
        }

        .modern-table tbody tr {
            transition: var(--transition);
        }

        .modern-table tbody tr:hover {
            background: var(--bg-hover);
        }

        .modern-table tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 0.375rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-qualified {
            background: rgba(16, 185, 129, 0.1);
            color: var(--accent-green);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-not-qualified {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem 0;
            gap: 1rem;
            background: var(--bg-card);
            border-top: 1px solid var(--border-light);
            border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
        }

        .pagination-controls button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--bg-hover);
            border-color: var(--primary-dark);
            color: var(--primary-dark);
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .analytics-section {
            margin-top: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
            position: relative;
        }

        .analytics-section .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .analytics-section .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
        }

        [data-theme="dark"] .chart-container {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 1rem;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.expanded {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }

        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .modern-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-dark);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .login-container {
            display: none;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 3rem;
            margin: 2rem;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .login-form {
            space-y: 1.5rem;
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            border: 1px solid rgba(239, 68, 68, 0.2);
            font-size: 0.875rem;
            margin-top: 1rem;
            display: none;
        }

        .login-button {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            margin-top: 1rem;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        @media print {
            @page {
                size: landscape;
            }

            body {
                background: white !important;
                color: black !important;
            }

            .modern-card.table-section {
                margin-top: 0 !important;
            }

            .modern-card.analytics-section.fade-in-up {
                display: none !important;
            }

            .modern-card {
                box-shadow: none !important;
                border: 1px solid #ccc !important;
            }

            .admin-header,
            .controls-section,
            .stats-section,
            .theme-toggle,
            .btn-modern,
            .pagination-controls,
            .analytics-section .section-header,
            .collapsible-content,
            .modern-table thead th:nth-child(7),
            .modern-table tbody td:nth-child(7) {
                display: none !important;
            }

            .modern-table thead th:nth-child(7),
            .modern-table tbody td:nth-child(7) {
                display: none !important;
            }

            .modern-table thead {
                display: table-header-group !important;
            }

            .modern-table tbody td::before {
                display: none !important;
            }

            .modern-table tbody td {
                display: table-cell !important;
                text-align: left !important;
                padding: 0.5rem !important;
            }

            .modern-table tbody tr {
                display: table-row !important;
                border: none !important;
                margin: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div id="login-section" class="login-container">
        <div class="modern-card login-card">
            <div class="login-header">
                <h2 class="login-title">Welcome Back</h2>
                <p class="login-subtitle">Sign in to access your dashboard</p>
            </div>
            <form class="login-form">
                <div class="form-group">
                    <label for="login-email" class="form-label">Email Address</label>
                    <input type="email" id="login-email" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="login-password" class="form-label">Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="Enter your password" required>
                </div>
                <div id="login-error" class="login-error"></div>
                <button type="button" id="login-button" class="btn-modern btn-primary login-button">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <div id="admin-panel" style="display: none;">
        <div class="container">
            <div class="modern-card admin-header fade-in-up">
                <div class="header-left">
                    <h1>SkillGate Dashboard</h1>
                    <p class="header-subtitle">Manage quiz results and analytics</p>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="welcome-badge">
                        <i class="fas fa-user-circle"></i>
                        Welcome, Admin
                    </div>
                    <div id="test-status-indicator" class="test-status-badge active">
                        <i class="fas fa-circle"></i> TEST ACTIVE
                    </div>
                    <div id="test-page-badge" class="test-page-badge">
                        <i class="fas fa-external-link-alt"></i> TEST PAGE
                    </div>
                    <button id="logout-button" class="btn-modern btn-danger">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>

            <div class="stats-section fade-in-up">
                <div class="stats-grid">
                    <div class="modern-card stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="modern-card stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value" id="qualified-users">0</div>
                        <div class="stat-label">Qualified</div>
                    </div>
                    <div class="modern-card stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-value" id="not-qualified-users">0</div>
                        <div class="stat-label">Not Qualified</div>
                    </div>
                    <div class="modern-card stat-card">
                        <div class="stat-icon info">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-value" id="avg-score">0%</div>
                        <div class="stat-label">Avg Score</div>
                    </div>
                </div>
            </div>

            <div class="modern-card controls-section fade-in-up">
                <div class="controls-layout">
                    <div class="filters-row">
                        <div class="filter-item">
                            <label for="search-input" class="form-label">Search</label>
                            <div class="input-group">
                                <input type="text" id="search-input" class="form-control" placeholder="Search by name or email...">
                                <button id="search-button" class="btn-modern btn-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="filter-item">
                            <label for="sort-by-select" class="form-label">Sort By</label>
                            <select id="sort-by-select" class="form-control">
                                <option value="timestamp-desc">Newest First</option>
                                <option value="timestamp-asc">Oldest First</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="email-asc">Email (A-Z)</option>
                                <option value="email-desc">Email (Z-A)</option>
                                <option value="score-desc" selected>Score (High to Low)</option>
                                <option value="score-asc">Score (Low to High)</option>
                                <option value="status-asc">Status (A-Z)</option>
                                <option value="status-desc">Status (Z-A)</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label for="status-filter-select" class="form-label">Filter by Status</label>
                            <select id="status-filter-select" class="form-control">
                                <option value="All">All</option>
                                <option value="Qualified">Qualified</option>
                                <option value="Not Qualified">Not Qualified</option>
                            </select>
                        </div>
                    </div>
                    <div class="actions-row">
                        <button id="refresh-button" class="btn-modern btn-success">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="print-button" class="btn-modern btn-info">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button id="export-csv-button" class="btn-modern btn-outline">
                            <i class="fas fa-file-csv"></i> Export CSV
                        </button>
                        <button id="send-invitations" class="btn-modern btn-warning">
                            <i class="fas fa-envelope"></i> Send Invitation
                        </button>
                        <button id="delete-all-button" class="btn-modern btn-danger">
                            <i class="fas fa-trash-alt"></i> Delete All
                        </button>
                        <button id="toggle-test-status-button" class="btn-modern btn-success">
                            <i class="fas fa-play-circle"></i> Resume Test
                        </button>
                    </div>
                </div>
            </div>

            <div class="modern-card analytics-section fade-in-up">
                <div class="section-header">
                    <h3 class="section-title">Quiz Performance Analytics</h3>
                    <button id="toggle-chart-button" class="btn-modern btn-outline">
                        <i class="fas fa-chevron-down"></i> Expand Chart
                    </button>
                </div>
                <div id="chart-collapsible-content" class="collapsible-content">
                    <div class="chart-container">
                        <canvas id="scoreDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="modern-card loading-container" id="loading-spinner">
                <div class="modern-spinner"></div>
                <p class="loading-text">Loading quiz results...</p>
            </div>

            <div class="modern-card table-section fade-in-up">
                <div class="table-header">
                    <h3 class="table-title">Quiz Results</h3>
                    <span id="total-records-count" class="text-muted">0 records</span>
                </div>
                <div class="table-container">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Score</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                        </tbody>
                    </table>
                </div>
                <div class="pagination-controls">
                    <button id="prev-page-button" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                    <span id="page-info" class="pagination-info">Page 1 of 1</span>
                    <button id="next-page-button" disabled>Next <i class="fas fa-chevron-right"></i></button>
                    <select id="results-per-page-select" class="form-control" style="width: auto; margin-left: 1rem;">
                        <option value="10">10 per page</option>
                        <option value="25">25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                        <option value="500">500 per page</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC55rgT41mwuf5y4q3P_Wi7zsLwO4RQAPQ",
            authDomain: "skillget-quiz.firebaseapp.com",
            projectId: "skillget-quiz",
            storageBucket: "skillget-quiz.firebasestorage.app",
            messagingSenderId: "222675456393",
            appId: "1:222675456393:web:931fae081fa10829d4d158"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Theme Management
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = themeToggle.querySelector('i');

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            if (window.scoreChart) {
                updateChartColors(savedTheme);
                window.scoreChart.update();
            }
        }

        function updateThemeIcon(theme) {
            themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            if (window.scoreChart) {
                updateChartColors(newTheme);
                window.scoreChart.update();
            }
        });

        initTheme();

        // Global variables for data and pagination
        let allQuizResults = [];
        let currentFilteredData = [];
        let currentPage = 1;
        let resultsPerPage = parseInt(document.getElementById('results-per-page-select')?.value) || 10;
        let totalPages = 1;
        let scoreChart = null;

        // Statistics Management
        function updateStatistics(data) {
            const totalUsers = data.length;
            const qualifiedUsers = data.filter(item => item.quiz_status === 'Qualified').length;
            const notQualifiedUsers = data.filter(item => item.quiz_status !== 'Qualified').length;
            const avgScore = totalUsers > 0 ? Math.round(data.reduce((sum, item) => sum + (item.score || 0), 0) / totalUsers) : 0;

            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('qualified-users').textContent = qualifiedUsers;
            document.getElementById('not-qualified-users').textContent = notQualifiedUsers;
            document.getElementById('avg-score').textContent = avgScore + '%';
        }

        // Function to render table rows for the current page
        function renderTablePage() {
            const resultsTableBody = document.getElementById('results-table-body');
            const totalRecordsCountElement = document.getElementById('total-records-count');
            const pageInfoElement = document.getElementById('page-info');
            const prevPageButton = document.getElementById('prev-page-button');
            const nextPageButton = document.getElementById('next-page-button');

            if (!resultsTableBody || !totalRecordsCountElement || !pageInfoElement || !prevPageButton || !nextPageButton) {
                console.error("HTML elements for table rendering not found.");
                return;
            }

            resultsTableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * resultsPerPage;
            const endIndex = startIndex + resultsPerPage;
            const paginatedData = currentFilteredData.slice(startIndex, endIndex);

            totalPages = Math.ceil(currentFilteredData.length / resultsPerPage);
            pageInfoElement.textContent = `Page ${currentPage} of ${totalPages}`;
            totalRecordsCountElement.textContent = `${currentFilteredData.length} records`;
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages || totalPages === 0;

            if (paginatedData.length === 0) {
                resultsTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center; padding: 3rem; color: var(--text-secondary);">
                            <i class="fas fa-inbox fa-3x mb-3" style="display: block; opacity: 0.3;"></i>
                            ${currentFilteredData.length === 0 ? "No matching results found." : "No results on this page."}
                        </td>
                    </tr>
                `;
                return;
            }

            let counter = startIndex + 1;
            const labels = ["ID", "Name", "Email", "Score", "Status", "Date"];

            paginatedData.forEach((data) => {
                const row = resultsTableBody.insertRow();
                row.className = 'fade-in-up';
                const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
                const statusClass = data.quiz_status === 'Qualified' ? 'status-qualified' : 'status-not-qualified';

                const cellData = [
                    counter,
                    data.name || 'N/A',
                    data.email || 'N/A',
                    data.score !== undefined ? data.score + '%' : 'N/A',
                    data.quiz_status || 'N/A',
                    timestamp
                ];

                cellData.forEach((value, index) => {
                    const cell = row.insertCell();
                    cell.setAttribute('data-label', labels[index]);
                    if (labels[index] === "Status") {
                        cell.innerHTML = `<span class="status-badge ${statusClass}">${value}</span>`;
                    } else {
                        cell.textContent = value;
                    }
                });

                const actionCell = row.insertCell();
                actionCell.setAttribute('data-label', 'Action');
                actionCell.innerHTML = `
                    <button class="btn-modern btn-info btn-sm send-invite-btn" data-email="${data.email}" data-name="${data.name}">
                        <i class="fas fa-paper-plane"></i>
                    </button>`;
                counter++;
            });
        }

        // Chart.js - Score Distribution Chart
        function renderScoreDistributionChart(data) {
            const ctx = document.getElementById('scoreDistributionChart');
            if (!ctx) {
                console.error("Score Distribution Chart canvas not found.");
                return;
            }

            if (window.scoreChart) {
                window.scoreChart.destroy();
            }

            const scoreRanges = {
                '0-20%': 0,
                '21-40%': 0,
                '41-60%': 0,
                '61-80%': 0,
                '81-100%': 0
            };

            data.forEach(item => {
                const score = item.score;
                if (score >= 0 && score <= 20) {
                    scoreRanges['0-20%']++;
                } else if (score >= 21 && score <= 40) {
                    scoreRanges['21-40%']++;
                } else if (score >= 41 && score <= 60) {
                    scoreRanges['41-60%']++;
                } else if (score >= 61 && score <= 80) {
                    scoreRanges['61-80%']++;
                } else if (score >= 81 && score <= 100) {
                    scoreRanges['81-100%']++;
                }
            });

            const chartData = {
                labels: Object.keys(scoreRanges),
                datasets: [{
                    label: 'Number of Users',
                    data: Object.values(scoreRanges),
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(59, 130, 246, 0.7)',
                        'rgba(102, 126, 234, 0.7)',
                        'rgba(16, 185, 129, 0.7)'
                    ],
                    borderColor: [
                        'rgba(239, 68, 68, 1)',
                        'rgba(245, 158, 11, 1)',
                        'rgba(59, 130, 246, 1)',
                        'rgba(102, 126, 234, 1)',
                        'rgba(16, 185, 129, 1)'
                    ],
                    borderWidth: 1
                }]
            };

            const getChartOptions = (theme) => {
                const isDark = theme === 'dark';
                const textColor = isDark ? 'white' : 'var(--text-primary)';
                const gridColor = isDark ? 'white' : 'var(--border-light)';

                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' users';
                                    }
                                    return label;
                                }
                            },
                            titleColor: textColor,
                            bodyColor: textColor,
                            backgroundColor: isDark ? 'var(--bg-card)' : 'var(--bg-card)',
                            borderColor: gridColor,
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor,
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false,
                            },
                            title: {
                                display: true,
                                text: 'Score Ranges',
                                color: textColor
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor,
                                precision: 0
                            },
                            grid: {
                                color: gridColor,
                                drawBorder: false,
                            },
                            title: {
                                display: true,
                                text: 'Number of Users',
                                color: textColor
                            }
                        }
                    }
                };
            };

            const currentTheme = document.documentElement.getAttribute('data-theme');
            window.scoreChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: getChartOptions(currentTheme)
            });
        }

        function updateChartColors(theme) {
            if (window.scoreChart) {
                const isDark = theme === 'dark';
                const textColor = isDark ? 'white' : 'var(--text-primary)';
                const gridColor = isDark ? 'white' : 'var(--border-light)';

                window.scoreChart.options.scales.x.ticks.color = textColor;
                window.scoreChart.options.scales.x.grid.color = gridColor;
                window.scoreChart.options.scales.x.title.color = textColor;

                window.scoreChart.options.scales.y.ticks.color = textColor;
                window.scoreChart.options.scales.y.grid.color = gridColor;
                window.scoreChart.options.scales.y.title.color = textColor;

                window.scoreChart.options.plugins.tooltip.titleColor = textColor;
                window.scoreChart.options.plugins.tooltip.bodyColor = textColor;
                window.scoreChart.options.plugins.tooltip.backgroundColor = isDark ? 'var(--bg-card)' : 'var(--bg-card)';
                window.scoreChart.options.plugins.tooltip.borderColor = gridColor;
            }
        }

        // Fetch Data from Firebase
        const fetchQuizResults = async () => {
            const loadingSpinner = document.getElementById('loading-spinner');
            loadingSpinner.style.display = 'flex';

            try {
                const snapshot = await db.collection('quiz_results').orderBy('timestamp', 'desc').get();
                allQuizResults = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                applyFiltersAndSort();
            } catch (error) {
                console.error("Error fetching quiz results:", error);
                alert("Error fetching quiz results. Please check your internet connection and try again.");
            } finally {
                loadingSpinner.style.display = 'none';
            }
        };

        // Apply all filters and sort
        function applyFiltersAndSort() {
            let filtered = [...allQuizResults];

            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(item =>
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.email && item.email.toLowerCase().includes(searchTerm))
                );
            }

            const statusFilter = document.getElementById('status-filter-select').value;
            if (statusFilter !== 'All') {
                filtered = filtered.filter(item => item.quiz_status === statusFilter);
            }

            const sortBy = document.getElementById('sort-by-select').value;
            filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'timestamp-desc': return (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0);
                    case 'timestamp-asc': return (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0);
                    case 'name-asc': return (a.name || '').localeCompare(b.name || '');
                    case 'name-desc': return (b.name || '').localeCompare(a.name || '');
                    case 'email-asc': return (a.email || '').localeCompare(b.email || '');
                    case 'email-desc': return (b.email || '').localeCompare(a.email || '');
                    case 'score-desc': return (b.score || 0) - (a.score || 0);
                    case 'score-asc': return (a.score || 0) - (b.score || 0);
                    case 'status-asc': return (a.quiz_status || '').localeCompare(b.quiz_status || '');
                    case 'status-desc': return (b.quiz_status || '').localeCompare(a.quiz_status || '');
                    default: return 0;
                }
            });

            currentFilteredData = filtered;
            currentPage = 1;
            updateStatistics(currentFilteredData);
            renderScoreDistributionChart(currentFilteredData);
            renderTablePage();
        }

        // Event Listeners for Filters and Sort
        document.getElementById('search-button')?.addEventListener('click', applyFiltersAndSort);
        document.getElementById('search-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                applyFiltersAndSort();
            }
        });
        document.getElementById('sort-by-select')?.addEventListener('change', applyFiltersAndSort);
        document.getElementById('status-filter-select')?.addEventListener('change', applyFiltersAndSort);

        // Pagination Event Listeners
        document.getElementById('prev-page-button')?.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTablePage();
            }
        });

        document.getElementById('next-page-button')?.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderTablePage();
            }
        });

        document.getElementById('results-per-page-select')?.addEventListener('change', (e) => {
            resultsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderTablePage();
        });

        // Other Buttons
        document.getElementById('refresh-button')?.addEventListener('click', fetchQuizResults);
        document.getElementById('print-button')?.addEventListener('click', () => window.print());

        document.getElementById('export-csv-button')?.addEventListener('click', () => {
            if (currentFilteredData.length === 0) {
                showModal('Export Failed', 'No data to export.');
                return;
            }

            let csvContent = "ID,Name,Email,Score,Status,Date\n";
            currentFilteredData.forEach((item, index) => {
                const id = index + 1;
                const name = `"${item.name || 'N/A'}"`;
                const email = `"${item.email || 'N/A'}"`;
                const score = item.score !== undefined ? item.score : 'N/A';
                const status = `"${item.quiz_status || 'N/A'}"`;
                const date = item.timestamp ? new Date(item.timestamp.toDate()).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'N/A';
                csvContent += `${id},${name},${email},${score},${status},${date}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'quiz_results.csv');
            link.click();
            URL.revokeObjectURL(url);
            showModal('Export Successful', '✅ Quiz results exported to CSV.');
        });

        // Delete All Button
        document.getElementById('delete-all-button')?.addEventListener('click', () => {
            showModal(
                'Confirm Deletion',
                'Are you sure you want to delete all quiz results? This action cannot be undone.',
                true,
                async () => {
                    try {
                        const batch = db.batch();
                        allQuizResults.forEach(doc => {
                            const docRef = db.collection('quiz_results').doc(doc.id);
                            batch.delete(docRef);
                        });
                        await batch.commit();
                        showModal('Deletion Successful', '✅ All quiz results have been deleted.');
                        fetchQuizResults();
                    } catch (error) {
                        console.error("Error deleting all documents:", error);
                        showModal('Deletion Failed', '❌ Failed to delete all quiz results. Please try again.');
                    }
                }
            );
        });

        // Chart Toggle Button
        document.getElementById('toggle-chart-button')?.addEventListener('click', function() {
            const chartCollapsibleContent = document.getElementById('chart-collapsible-content');
            const icon = this.querySelector('i');
            if (chartCollapsibleContent.classList.contains('expanded')) {
                chartCollapsibleContent.classList.remove('expanded');
                icon.className = 'fas fa-chevron-down';
                this.innerHTML = '<i class="fas fa-chevron-down"></i> Expand Chart';
            } else {
                chartCollapsibleContent.classList.add('expanded');
                icon.className = 'fas fa-chevron-up';
                this.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse Chart';
                if (window.scoreChart) {
                    window.scoreChart.resize();
                    window.scoreChart.update();
                }
            }
        });

        // Custom Modal Implementation
        function showModal(title, message, isConfirm = false, onConfirm = null) {
            let modalOverlay = document.getElementById('custom-modal-overlay');
            if (!modalOverlay) {
                modalOverlay = document.createElement('div');
                modalOverlay.id = 'custom-modal-overlay';
                modalOverlay.className = 'modal-overlay';
                document.body.appendChild(modalOverlay);
            }

            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div class="modal-buttons">
                        ${isConfirm ? `<button id="modal-confirm-btn" class="btn-modern btn-danger">Confirm</button>` : ''}
                        <button id="modal-close-btn" class="btn-modern btn-outline">${isConfirm ? 'Cancel' : 'Close'}</button>
                    </div>
                </div>
            `;

            document.body.classList.add('modal-open');
            modalOverlay.classList.add('modal-show');

            document.getElementById('modal-close-btn').addEventListener('click', () => {
                modalOverlay.classList.remove('modal-show');
                document.body.classList.remove('modal-open');
            });

            if (isConfirm) {
                document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                    modalOverlay.classList.remove('modal-show');
                    document.body.classList.remove('modal-open');
                    if (onConfirm) onConfirm();
                });
            }
        }

        // EmailJS Integration
        // Initialize EmailJS with your public key
        (function() {
            // Replace with your actual EmailJS public key
            const publicKey = "KU4KQRBITiPfUBiQr";
            
            if (publicKey === "YOUR_PUBLIC_KEY") {
                console.error("⚠️ EmailJS Public Key not configured! Please replace 'YOUR_PUBLIC_KEY' with your actual EmailJS public key.");
                showModal('EmailJS Configuration Error', '⚠️ EmailJS is not properly configured. Please check the setup instructions and update your public key, service ID, and template ID.');
                return;
            }
            
            try {
                emailjs.init(publicKey);
                console.log("✅ EmailJS initialized successfully");
            } catch (error) {
                console.error("❌ Failed to initialize EmailJS:", error);
                showModal('EmailJS Initialization Error', '❌ Failed to initialize EmailJS. Please check your configuration.');
            }
        })();

        // EmailJS Configuration - Update these with your actual values
        const EMAILJS_CONFIG = {
            SERVICE_ID: "service_awkl67c",  // Your actual service ID
            TEMPLATE_ID: "template_jbq1bxm", // Your actual template ID
            PUBLIC_KEY: "KU4KQRBITiPfUBiQr"    // Your actual public key
        };

        // Enhanced email sending function with better error handling
        async function sendEmailWithErrorHandling(recipientEmail, recipientName) {
            try {
                // Validate configuration
                if (EMAILJS_CONFIG.PUBLIC_KEY === "YOUR_PUBLIC_KEY") {
                    throw new Error("EmailJS not configured. Please update your public key, service ID, and template ID.");
                }

                console.log("Sending email to:", recipientEmail);
                
                const result = await emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_ID,
                    {
                        to_email: recipientEmail,
                        name: recipientName,
                        from_name: "SkillGate Team" // Optional: add sender name
                    }
                );
                
                console.log("✅ Email sent successfully:", result);
                return { success: true, result };
                
            } catch (error) {
                console.error("❌ EmailJS Error:", error);
                
                // Provide specific error messages based on error type
                let errorMessage = "Failed to send email";
                if (error.text) {
                    errorMessage = error.text;
                } else if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                }
                
                return { success: false, error: errorMessage };
            }
        }

        // Fallback for when EmailJS is not properly loaded
        if (typeof emailjs === 'undefined') {
            console.error("❌ EmailJS library is not loaded. Please check your internet connection.");
            window.emailjs = {
                send: async (serviceId, templateId, templateParams) => {
                    console.warn("EmailJS is not initialized. Cannot send email. Params:", templateParams);
                    return new Promise((resolve, reject) => {
                        setTimeout(() => {
                            console.log("Simulating email send for:", templateParams.to_email);
                            reject(new Error("EmailJS library not loaded"));
                        }, 1000);
                    });
                }
            };
        }

        document.getElementById("send-invitations")?.addEventListener("click", () => {
            showModal(
                'Confirm Bulk Invitation',
                `Are you sure you want to send invitations to all ${currentFilteredData.filter(u => u.quiz_status === 'Qualified').length} qualified users? This might take a while.`,
                true,
                async () => {
                    const qualifiedUsers = currentFilteredData.filter(u => u.quiz_status === 'Qualified');
                    if (qualifiedUsers.length === 0) {
                        showModal('No Qualified Users', 'There are no qualified users to send invitations to.');
                        return;
                    }

                    showModal('Sending Invitations', `Sending invitations to ${qualifiedUsers.length} qualified users. Please do not close this window.`, false);

                    let sentCount = 0;
                    let failedCount = 0;
                    for (const user of qualifiedUsers) {
                        const result = await sendEmailWithErrorHandling(user.email, user.name);
                        if (result.success) {
                            sentCount++;
                        } else {
                            console.error(`Failed to send invitation to ${user.email}:`, result.error);
                            failedCount++;
                        }
                    }
                    showModal('Invitation Batch Complete', `✅ Sent ${sentCount} invitations. ❌ Failed to send ${failedCount} invitations.`);
                }
            );
        });

        document.addEventListener("click", async (e) => {
            if (e.target.closest(".send-invite-btn")) {
                const btn = e.target.closest(".send-invite-btn");
                const email = btn.getAttribute("data-email");
                const name = btn.getAttribute("data-name");

                const user = allQuizResults.find(u => u.email === email);

                if (user && user.quiz_status === 'Qualified') {
                    btn.disabled = true;
                    btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;

                    const result = await sendEmailWithErrorHandling(email, name);
                    
                    if (result.success) {
                        showModal('Invitation Sent', `✅ Invitation sent to ${name}`);
                    } else {
                        console.error("Failed to send invitation:", result.error);
                        showModal('Invitation Failed', `❌ Failed to send to ${name}: ${result.error}`);
                    }
                    
                    btn.disabled = false;
                    btn.innerHTML = `<i class="fas fa-paper-plane"></i>`;
                } else {
                    showModal('Cannot Send Invitation', `User ${name} is not qualified.`);
                }
            }
        });

        // Authentication Logic
        auth.onAuthStateChanged(user => {
            const loginSection = document.getElementById('login-section');
            const adminPanel = document.getElementById('admin-panel');
            if (user) {
                loginSection.style.display = 'none';
                adminPanel.style.display = 'block';
                fetchQuizResults();
                setupTestStatusListener();
            } else {
                loginSection.style.display = 'flex';
                adminPanel.style.display = 'none';
            }
        });

        document.getElementById('login-button')?.addEventListener('click', async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginError = document.getElementById('login-error');
            try {
                await auth.signInWithEmailAndPassword(email, password);
                loginError.style.display = 'none';
            } catch (error) {
                loginError.textContent = error.message;
                loginError.style.display = 'block';
                console.error("Login Error:", error);
            }
        });

        document.getElementById('logout-button')?.addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("Logout Error:", error);
                alert("Error logging out. Please try again.");
            }
        });

        // Test Status Management (NEW CODE)
        const testStatusDocRef = db.collection('app_settings').doc('test_status');
        const toggleTestStatusButton = document.getElementById('toggle-test-status-button');

        async function updateTestStatusButton(status) {
            const testStatusIndicator = document.getElementById('test-status-indicator');
            
            if (toggleTestStatusButton) {
                if (status === 'paused') {
                    toggleTestStatusButton.innerHTML = '<i class="fas fa-play-circle"></i> Resume Test';
                    toggleTestStatusButton.classList.remove('btn-primary');
                    toggleTestStatusButton.classList.add('btn-success');
                } else {
                    toggleTestStatusButton.innerHTML = '<i class="fas fa-pause-circle"></i> Pause Test';
                    toggleTestStatusButton.classList.remove('btn-success');
                    toggleTestStatusButton.classList.add('btn-primary');
                }
            }

            if (testStatusIndicator) {
                testStatusIndicator.className = `test-status-badge ${status}`;
                if (status === 'paused') {
                    testStatusIndicator.innerHTML = '<i class="fas fa-circle"></i> TEST PAUSED';
                } else {
                    testStatusIndicator.innerHTML = '<i class="fas fa-circle"></i> TEST ACTIVE';
                }
            }
        }

        async function fetchAndSetInitialTestStatus() {
            try {
                const doc = await testStatusDocRef.get();
                let status = 'active';
                if (doc.exists && doc.data().status) {
                    status = doc.data().status;
                } else {
                    await testStatusDocRef.set({ status: 'active' });
                }
                updateTestStatusButton(status);
            } catch (error) {
                console.error("Error fetching initial test status:", error);
                showModal('Error', 'Failed to load test status. Please refresh.');
            }
        }

        function setupTestStatusListener() {
            if (toggleTestStatusButton) {
                testStatusDocRef.onSnapshot((doc) => {
                    if (doc.exists && doc.data().status) {
                        const newStatus = doc.data().status;
                        updateTestStatusButton(newStatus);
                    } else {
                        updateTestStatusButton('active');
                    }
                }, (error) => {
                    console.error("Error listening to test status changes:", error);
                    showModal('Error', 'Failed to listen for test status updates.');
                });

                toggleTestStatusButton.addEventListener('click', async () => {
                    try {
                        const doc = await testStatusDocRef.get();
                        let currentStatus = 'active';
                        if (doc.exists && doc.data().status) {
                            currentStatus = doc.data().status;
                        }

                        const newStatus = currentStatus === 'active' ? 'paused' : 'active';
                        await testStatusDocRef.update({ status: newStatus });
                        showModal('Test Status Updated', `Test is now ${newStatus}.`);
                    } catch (error) {
                        console.error("Error updating test status:", error);
                        showModal('Error', 'Failed to update test status.');
                    }
                });
            }
        }

        fetchAndSetInitialTestStatus();

        // Test Page Badge Click Handler
        document.getElementById('test-page-badge')?.addEventListener('click', () => {
            window.open('https://skillgatequiz.netlify.app/index.html', '_blank');
        });
    </script>
</body>
</html>

